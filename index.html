<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IMDb Streamer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Font Awesome for trashcan icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #00c8ff;
      --accent-color: #00ff85;
      --bg-color: #121212;
      --light-bg: #1e1e1e;
      --text-color: #ffffff;
      --border-radius: 12px;
      --transition-speed: 0.3s;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    /* Main content - centered */
    .main-content {
      width: 100%;
      max-width: 1200px;
      min-height: 70vh;
      background-color: var(--light-bg);
      border-radius: var(--border-radius);
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 25px;
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.4);
      position: relative;
      margin-bottom: 30px;
    }

    /* Reviews section at bottom */
    .reviews-section {
      width: 100%;
      max-width: 1200px;
      background-color: var(--light-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.25);
      margin-top: 20px;
    }

    /* Review grid layout */
    .reviews-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    /* Adblock Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-box {
      background-color: var(--light-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.5);
      text-align: center;
      animation: modalFadeIn 0.4s ease-out;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-box h2 {
      color: var(--accent-color);
      margin-bottom: 15px;
    }

    .modal-box p {
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .modal-box button {
      padding: 10px 25px;
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
      border: none;
      border-radius: 5px;
      color: var(--bg-color);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      transform: scale(1);
    }

    .modal-box button:hover {
      filter: brightness(1.1);
      transform: scale(1.05);
    }

    .modal-box button:active {
      transform: scale(0.98);
    }

    /* Edit Review Modal */
    .edit-review-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .edit-review-content {
      background-color: var(--light-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.5);
      animation: modalFadeIn 0.4s ease-out;
    }

    .edit-review-content h2 {
      color: var(--accent-color);
      margin-bottom: 15px;
    }

    .edit-review-content p {
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .edit-review-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .edit-review-buttons button {
      padding: 8px 20px;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .edit-review-buttons .confirm-btn {
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
      border: none;
      color: var(--bg-color);
    }

    .edit-review-buttons .cancel-btn {
      background: none;
      border: 1px solid #666;
      color: var(--text-color);
    }

    /* Delete Confirmation Modal */
    .delete-confirm-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .delete-confirm-content {
      background-color: var(--light-bg);
      padding: 25px;
      border-radius: var(--border-radius);
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.5);
      animation: modalFadeIn 0.4s ease-out;
    }

    .delete-confirm-content h2 {
      color: #ff4d4d;
      margin-bottom: 15px;
    }

    .delete-confirm-content p {
      margin-bottom: 15px;
      line-height: 1.5;
    }

    .delete-confirm-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .delete-confirm-buttons button {
      padding: 8px 20px;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-confirm-buttons .confirm-btn {
      background: linear-gradient(45deg, #ff4d4d, #ff9999);
      border: none;
      color: var(--bg-color);
    }

    .delete-confirm-buttons .cancel-btn {
      background: none;
      border: 1px solid #666;
      color: var(--text-color);
    }

    /* Message Styles */
    .error-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ff4d4d;
      color: white;
      padding: 12px 24px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(255, 77, 77, 0.3);
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -30px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    .error-message::before {
      content: "⚠️";
      font-size: 1.2rem;
    }

    .success-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--accent-color);
      color: var(--bg-color);
      padding: 12px 24px;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0, 255, 133, 0.3);
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease-out;
    }

    .fade-out {
      animation: fadeOut 0.5s ease-out forwards;
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: translate(-50%, -20px);
      }
    }

    /* Button Animations */
    .search-container button {
      padding: 0.75rem 1.5rem;
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
      border: none;
      border-radius: 5px;
      color: var(--bg-color);
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      transform: scale(1);
      position: relative;
      overflow: hidden;
    }

    .search-container button:hover {
      filter: brightness(1.1);
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 200, 255, 0.4);
    }

    .search-container button:active {
      transform: scale(0.98);
    }

    /* Clear button specific styles */
    #clearBtn {
      background: linear-gradient(45deg, #ff4d4d, #ff9999);
    }

    #clearBtn:hover {
      filter: brightness(1.1);
    }

    .guidance-section {
      width: 100%;
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
      text-align: center;
      opacity: 0;
      transform: translateY(20px);
      max-height: 0;
      overflow: hidden;
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    .guidance-section.visible {
      opacity: 1;
      transform: translateY(0);
      max-height: 1000px;
      padding: 20px 0;
    }

    .guidance-section h2 {
      font-size: 2rem;
      border-left: 4px solid var(--primary-color);
      padding-left: 12px;
      margin-bottom: 10px;
      align-self: flex-start;
      animation: fadeInSlideLeft 0.6s ease-out 0.2s both;
    }

    .services {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .service {
      background-color: #232323;
      padding: 14px 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 0 8px rgba(0, 200, 255, 0.25);
      transition: all 0.3s ease;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInSlideUp 0.5s ease-out forwards;
    }

    .service:nth-child(1) { animation-delay: 0.3s; }
    .service:nth-child(2) { animation-delay: 0.4s; }
    .service:nth-child(3) { animation-delay: 0.5s; }
    .service:nth-child(4) { animation-delay: 0.6s; }

    .service:hover {
      background-color: #2a2a2a;
      transform: translateY(-3px);
    }

    .service h3 {
      color: var(--primary-color);
      font-size: 1.25rem;
      margin-bottom: 8px;
    }

    .service code {
      display: inline-block;
      background-color: #2a2a2a;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 1rem;
    }

    @keyframes fadeInSlideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInSlideLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .player-container {
      width: 100%;
      height: 70vh;
      display: none;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.5s ease-in-out;
      position: relative;
    }

    .player-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.6);
    }

    .loader {
      border: 4px solid rgba(0, 200, 255, 0.2);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      margin: 20px auto;
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .search-container {
      width: 100%;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .search-container input {
      flex-grow: 1;
      min-width: 220px;
      padding: 0.75rem;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .search-container input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--primary-color);
    }

    .recent-movies {
      width: 100%;
      margin-top: auto; /* Push to bottom */
      background-color: var(--light-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.25);
      display: none;
    }

    .recent-movies h3 {
      margin-bottom: 12px;
      color: var(--accent-color);
      font-size: 1.5rem;
      border-left: 4px solid var(--accent-color);
      padding-left: 12px;
    }

    .recent-movies .id-list {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px 20px;
      max-height: none;
    }

    .recent-movies .id-list button {
      background-color: #232323;
      border: none;
      color: var(--text-color);
      padding: 14px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 0 8px rgba(0, 200, 255, 0.25);
      font-size: 1rem;
      text-align: left;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      min-width: 0;
      position: relative;
      overflow: hidden;
    }

    .recent-movies .id-list button:hover {
      background-color: #2b2b2b;
      transform: translateY(-2px);
    }

    .recent-movies .id-list button:active {
      transform: translateY(0);
    }

    .recent-movies .id-list button img {
      width: 50px;
      height: 75px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
      box-shadow: 0 0 6px rgba(0, 200, 255, 0.5);
    }

    .recent-movies .id-list button .movie-info {
      display: flex;
      flex-direction: column;
      text-align: left;
      flex-grow: 1;
      overflow: hidden;
    }

    .recent-movies .id-list button strong {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .recent-movies .id-list button small {
      font-size: 0.9rem;
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: color var(--transition-speed);
    }

    .media-type-badge {
      display: inline-block;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 4px;
      color: var(--bg-color);
      margin-top: 4px;
      align-self: flex-start;
    }

    .media-type-badge.movie {
      background-color: var(--primary-color);
    }

    .media-type-badge.series {
      background-color: var(--accent-color);
    }

    .media-type-badge.unknown {
      background-color: #ff4d4d;
      color: white;
    }

    /* Ripple Effect */
    .ripple {
      position: absolute;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.4);
      transform: scale(0);
      animation: ripple 0.6s linear;
      pointer-events: none;
    }

    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

    /* Fullscreen Button */
    .fullscreen-btn {
      position: absolute;
      bottom: 7px;
      right: 3px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #000;
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s ease;
      z-index: 20;
      opacity: 1;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .fullscreen-btn:hover {
      background: #000;
      border-color: var(--primary-color);
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.5);
    }

    .fullscreen-btn:focus {
      outline: none;
    }

    /* Overlay to hide controls */
    .controls-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      pointer-events: none;
      z-index: 10;
    }

    /* Review Section Styles */
    .review-section {
      width: 100%;
      margin-top: 30px;
      background-color: var(--light-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.25);
      display: none;
    }

    .review-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .rating-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .rating-stars {
      display: flex;
      gap: 5px;
    }

    .rating-stars .star {
      font-size: 24px;
      color: #555;
      cursor: pointer;
      transition: color 0.2s;
    }

    .rating-stars .star.active {
      color: gold;
    }

    .review-form textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background-color: #232323;
      color: white;
      resize: vertical;
    }

    .name-input-container {
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    .review-form .name-field {
      flex-grow: 1;
      position: relative;
    }

    .review-form .name-field::before {
      content: "-";
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-color);
    }

    .review-form .name-input {
      width: 100%;
      padding: 10px 10px 10px 20px;
      border-radius: 8px;
      border: 1px solid #333;
      background-color: #232323;
      color: white;
    }

    .review-form button {
      padding: 8px 20px;
      background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
      border: none;
      border-radius: 5px;
      color: var(--bg-color);
      font-weight: 600;
      cursor: pointer;
      height: 40px;
    }

    /* Review Item Styles */
    .review-item {
      background-color: #232323;
      padding: 15px;
      border-radius: var(--border-radius);
      border-left: 4px solid var(--primary-color);
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
    }

    .review-item:hover {
      transform: translateY(-3px);
    }

    .review-item-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .review-item:hover .review-item-actions {
      opacity: 1;
    }

    .delete-review-btn {
      background: none;
      border: none;
      color: #ff4d4d;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .delete-review-btn:hover {
      transform: scale(1.2);
      color: #ff0000;
    }

    .delete-review-btn i {
      transition: transform 0.3s;
    }

    .delete-review-btn:hover i {
      animation: shake 0.5s;
    }

    @keyframes shake {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(10deg); }
      50% { transform: rotate(-10deg); }
      75% { transform: rotate(10deg); }
      100% { transform: rotate(0deg); }
    }

    .review-movie-info {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
      align-items: center;
    }

    .review-movie-poster {
      width: 50px;
      height: 75px;
      object-fit: cover;
      border-radius: 5px;
    }

    .review-movie-details {
      flex: 1;
    }

    .review-movie-title {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .review-movie-id {
      font-size: 0.8rem;
      color: #aaa;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .review-rating {
      color: gold;
      font-weight: normal;
      font-size: 20px;
      white-space: nowrap;
    }

    .review-date {
      color: #aaa;
      font-size: 0.8rem;
      white-space: nowrap;
    }

    .review-content {
      line-height: 1.5;
      font-size: 14px;
      word-break: break-word;
    }

    .review-author {
      display: block;
      text-align: left;
      font-style: normal;
      background: linear-gradient(2deg, var(--primary-color), var(--accent-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: color var(--transition-speed);
      font-size: 14px;
      margin-top: 10px;
    }

    .no-reviews {
      color: #aaa;
      text-align: center;
      padding: 20px;
      grid-column: 1 / -1;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Smooth scroll animation */
    html {
      scroll-behavior: smooth;
    }

    /* Updated Recent Reviews header style */
    .reviews-section h3 {
      margin-bottom: 12px;
      color: var(--accent-color);
      font-size: 1.5rem;
      border-left: 4px solid var(--accent-color);
      padding-left: 12px;
    }

    /* Movie item delete button */
    .movie-item-actions {
      position: absolute;
      top: 10px;
      right: 10px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .recent-movies .id-list button:hover .movie-item-actions {
      opacity: 1;
    }

    .delete-movie-btn {
      background: none;
      border: none;
      color: #ff4d4d;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s;
      padding: 0;
      margin: 0;
    }

    .delete-movie-btn:hover {
      transform: scale(1.2);
      color: #ff0000;
    }

    .delete-movie-btn i {
      transition: transform 0.3s;
    }

    .delete-movie-btn:hover i {
      animation: shake 0.5s;
    }

    /* Search Results Styles */
    .initial-search-results {
      width: 100%;
      max-height: 300px;
      overflow-y: auto;
      background-color: var(--light-bg);
      border-radius: var(--border-radius);
      margin: 10px 0;
      display: none;
      box-shadow: 0 0 10px rgba(0, 200, 255, 0.2);
      padding: 10px;
    }

    .initial-search-results.visible {
      display: block;
    }

    /* Hide scrollbar for search results */
    .initial-search-results::-webkit-scrollbar {
      display: none;
    }

    .initial-search-results {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .initial-movie-item {
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .initial-movie-item:hover {
      background-color: #2a2a2a;
    }

    .initial-movie-item .poster {
      width: 40px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .initial-movie-item .info {
      flex: 1;
      min-width: 0;
    }

    .initial-movie-item .title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.95rem;
    }

    .initial-movie-item .year {
      color: var(--accent-color);
      font-size: 0.8rem;
    }

    .initial-movie-item .id {
      font-family: monospace;
      font-size: 0.75rem;
      color: #aaa;
      background-color: #2a2a2a;
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Updated Search Results Styles */
    .search-results {
      width: 100%;
      max-height: 70vh;
      overflow-y: auto;
      background-color: var(--light-bg);
      border-radius: var(--border-radius);
      margin: 10px 0;
      display: none;
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.25);
      padding: 20px;
    }

    .search-results.visible {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 25px;
    }

    /* Hide scrollbar for search results */
    .search-results::-webkit-scrollbar {
      display: none;
    }

    .search-results {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .movie-card {
      background-color: #232323;
      border-radius: var(--border-radius);
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .movie-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 200, 255, 0.3);
    }

    .movie-poster {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-bottom: 2px solid var(--primary-color);
    }

    .movie-details {
      padding: 15px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .movie-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-color);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-year {
      font-size: 0.9rem;
      color: var(--accent-color);
      margin-bottom: 5px;
    }

    .movie-type {
      font-size: 0.8rem;
      color: #aaa;
      margin-bottom: 5px;
      text-transform: capitalize;
    }

    .movie-id {
      font-size: 0.8rem;
      color: #aaa;
      font-family: monospace;
      background-color: #2a2a2a;
      padding: 3px 6px;
      border-radius: 4px;
      display: inline-block;
      align-self: flex-start;
    }

    .no-results {
      grid-column: 1 / -1;
      padding: 30px;
      text-align: center;
      color: #aaa;
      font-size: 1.1rem;
    }

    .search-loading {
      grid-column: 1 / -1;
      padding: 30px;
      text-align: center;
      color: var(--primary-color);
      font-size: 1.1rem;
    }

    .help-button {
      width: 100%;
      margin: 15px 0;
      text-align: center;
      display: none;
    }

    .help-button.visible {
      display: block;
    }

    .help-button button {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
      padding: 10px 20px;
      border-radius: 30px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 0 auto;
    }

    .help-button button:hover {
      background-color: rgba(0, 200, 255, 0.1);
      transform: translateY(-2px);
    }

    .help-button button:active {
      transform: translateY(0);
    }

    .help-button button::before {
      content: "?";
      display: inline-block;
      width: 20px;
      height: 20px;
      background-color: var(--primary-color);
      color: var(--bg-color);
      border-radius: 50%;
      text-align: center;
      line-height: 20px;
      font-weight: bold;
    }

    @media (max-width: 1200px) {
      .search-container-wrapper,
      .main-content {
        width: 95vw;
        padding: 20px;
      }
      .recent-movies .id-list {
        grid-template-columns: repeat(2, 1fr);
      }
      .reviews-grid {
        grid-template-columns: 1fr;
      }
      .search-results.visible {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .recent-movies .id-list {
        grid-template-columns: 1fr;
      }
      .search-container {
        flex-direction: column;
      }
      .modal-box {
        padding: 20px 15px;
      }
      .name-input-container {
        flex-direction: column;
        align-items: flex-start;
      }
      .review-form button {
        width: 100%;
      }
      .search-results.visible {
        grid-template-columns: 1fr;
      }
      .movie-poster {
        height: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- Adblock Recommendation Modal -->
  <div class="modal-overlay" id="adblockModal">
    <div class="modal-box">
      <h2>Ad Notice</h2>
      <p>The video player may display advertisements when you interact with it. We recommend using an adblocker for a smoother experience.</p>
      <button onclick="closeAdblockModal()">I Understand</button>
    </div>
  </div>

  <!-- Edit Review Modal -->
  <div class="edit-review-modal" id="editReviewModal">
    <div class="edit-review-content">
      <h2>You've Already Reviewed This</h2>
      <p>Our records show you've already submitted a review for this movie. Would you like to update your existing review?</p>
      <div class="edit-review-buttons">
        <button class="cancel-btn" onclick="closeEditReviewModal()">Cancel</button>
        <button class="confirm-btn" onclick="confirmEditReview()">Update Review</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="delete-confirm-modal" id="deleteConfirmModal">
    <div class="delete-confirm-content">
      <h2>Delete Review</h2>
      <p>Are you sure you want to delete this review? This action cannot be undone.</p>
      <div class="delete-confirm-buttons">
        <button class="cancel-btn" onclick="closeDeleteConfirmModal()">Cancel</button>
        <button class="confirm-btn" onclick="confirmDeleteReview()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Delete Movie Confirmation Modal -->
  <div class="delete-confirm-modal" id="deleteMovieConfirmModal">
    <div class="delete-confirm-content">
      <h2>Delete Recent Movie</h2>
      <p>Are you sure you want to delete this movie from your recent list? This action cannot be undone.</p>
      <div class="delete-confirm-buttons">
        <button class="cancel-btn" onclick="closeDeleteMovieConfirmModal()">Cancel</button>
        <button class="confirm-btn" onclick="confirmDeleteMovie()">Delete</button>
      </div>
    </div>
  </div>

  <!-- Main Content - Centered -->
  <div class="main-content">
    <div class="search-container">
      <input
        type="text"
        id="imdbInput"
        placeholder="Search by title or IMDb ID (e.g. Title or tt1375666)"
        autocomplete="off"
      />
      <button id="searchBtn">Search</button>
      <button id="clearBtn">Clear</button>
    </div>
    <div class="initial-search-results" id="initialSearchResults"></div>
    <div class="search-results" id="searchResults"></div>

    <div class="help-button" id="helpButton">
      <button id="helpToggle">I can't find the movie I'm looking for</button>
    </div>

    <div class="guidance-section" id="guidanceSection">
      <h2>How to Find IMDb IDs</h2>
      <div class="services">
        <div class="service">
          <h3>Step 1: Visit IMDb</h3>
          <p>
            Go to
            <a
              href="https://www.imdb.com"
              target="_blank"
              rel="noopener noreferrer"
              style="color: var(--accent-color)"
              >IMDb.com</a
            ></p>
        </div>
        <div class="service">
          <h3>Step 2: Search</h3>
          <p>Find a movie/series and open its page.</p>
        </div>
        <div class="service">
          <h3>Step 3: Copy the IMDb ID</h3>
          <p>From the URL, copy the ID e.g. <code>tt4589218</code></p>
        </div>
        <div class="service">
          <h3>Step 4: Paste It</h3>
          <p>Use the ID to stream the movie above.</p>
        </div>
      </div>
    </div>

    <div id="playerContainer" class="player-container">
      <div class="loader" id="loader"></div>
      <div class="controls-overlay"></div>
      <button class="fullscreen-btn" id="fullscreenBtn" aria-label="Toggle fullscreen">⛶</button>
    </div>

    <div class="review-section" id="reviewSection">
      <h3>Rate & Review</h3>
      <div class="review-form" id="reviewForm">
        <div class="rating-container">
          <span>Rating:</span>
          <div class="rating-stars" id="ratingStars">
            <span class="star" data-value="1">★</span>
            <span class="star" data-value="2">★</span>
            <span class="star" data-value="3">★</span>
            <span class="star" data-value="4">★</span>
            <span class="star" data-value="5">★</span>
          </div>
        </div>
        <textarea id="reviewText" placeholder="Write your review here..." required></textarea>
        <div class="name-input-container">
          <div class="name-field">
            <input type="text" id="reviewerName" class="name-input" placeholder="Your name (required)" required>
          </div>
          <button id="submitReviewBtn">Submit Review</button>
        </div>
      </div>
    </div>

    <div class="recent-movies" id="recentMoviesSection">
      <h3>Recent Movies</h3>
      <div class="id-list" id="recentMoviesList"></div>
    </div>
  </div>

  <!-- Reviews Section at Bottom -->
  <div class="reviews-section" id="reviewsSection">
    <h3>Recent Reviews</h3>
    <div class="reviews-grid" id="reviewsGrid">
      <div class="no-reviews">No reviews yet. Be the first to review!</div>
    </div>
  </div>

  <script>
    // Initialize Firebase with only the safe-to-expose config
    const firebaseConfig = {
      apiKey: "AIzaSyBGSvRU7Bxo5X2qKi1agvM88NxUR3PjHMM",
      authDomain: "reviews-48f23.firebaseapp.com",
      projectId: "reviews-48f23"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let authInitialized = false;

    // Enable offline persistence
    db.enablePersistence()
      .catch((err) => {
        if (err.code == 'failed-precondition') {
          // Multiple tabs open, persistence can only be enabled in one tab at a time
          console.log('Persistence failed: multiple tabs open');
        } else if (err.code == 'unimplemented') {
          // The current browser does not support all of the features required
          console.log('Persistence is not supported in this browser');
        }
      });

    // DOM elements
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const playerContainer = document.getElementById('playerContainer');
    const imdbInput = document.getElementById('imdbInput');
    const guidanceSection = document.getElementById('guidanceSection');
    const loader = document.getElementById('loader');
    const recentMoviesSection = document.getElementById('recentMoviesSection');
    const recentMoviesList = document.getElementById('recentMoviesList');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const adblockModal = document.getElementById('adblockModal');
    const reviewSection = document.getElementById('reviewSection');
    const reviewForm = document.getElementById('reviewForm');
    const ratingStars = document.getElementById('ratingStars');
    const reviewerName = document.getElementById('reviewerName');
    const reviewText = document.getElementById('reviewText');
    const submitReviewBtn = document.getElementById('submitReviewBtn');
    const reviewsGrid = document.getElementById('reviewsGrid');
    const editReviewModal = document.getElementById('editReviewModal');
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const deleteMovieConfirmModal = document.getElementById('deleteMovieConfirmModal');
    const initialSearchResults = document.getElementById('initialSearchResults');
    const searchResults = document.getElementById('searchResults');
    const helpButton = document.getElementById('helpButton');
    const helpToggle = document.getElementById('helpToggle');

    // App constants and variables
    const OMDB_API_KEY = '43f4542f';
    const MAX_REVIEWS = 45; // Maximum number of reviews to keep
    let currentIframe = null;
    let isMediaLoaded = false;
    let currentImdbID = null;
    let selectedRating = 0;
    let currentMovieDetails = null;
    let allMovieDetailsCache = {};
    let userIP = null;
    let isTypingReview = false;
    let pendingReviewData = null;
    let existingReviewDocId = null;
    let reviewToDeleteId = null;
    let movieToDeleteId = null;
    let currentUserId = null;
    let searchTimeout = null;
    let hasSearched = false;
    let helpButtonClicked = false;

    /* Initialize Firebase Authentication */
    async function initializeAuth() {
      if (authInitialized) return;
      try {
        await firebase.auth().signInAnonymously();
        authInitialized = true;
        currentUserId = firebase.auth().currentUser?.uid;
      } catch (error) {
        console.error("Authentication error:", error);
      }
    }

    /* Get User IP Address */
    async function getUserIP() {
      if (userIP) return userIP;
      
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        userIP = data.ip;
        return userIP;
      } catch (error) {
        console.error("Error fetching IP:", error);
        // Fallback to a random ID if IP fetch fails
        userIP = 'user-' + Math.random().toString(36).substring(2, 15);
        return userIP;
      }
    }

    /* Check if user has already reviewed a movie */
    async function hasUserReviewed(imdbID) {
      const ip = await getUserIP();
      await initializeAuth();
      const userId = firebase.auth().currentUser?.uid;
      
      try {
        // First check by user ID (if authenticated)
        if (userId) {
          const userQuery = await db.collection('reviews')
            .where('imdbID', '==', imdbID)
            .where('userId', '==', userId)
            .limit(1)
            .get();
          
          if (!userQuery.empty) {
            return {
              exists: true,
              docId: userQuery.docs[0].id,
              review: userQuery.docs[0].data()
            };
          }
        }
        
        // Then check by IP address
        const ipQuery = await db.collection('reviews')
          .where('imdbID', '==', imdbID)
          .where('userIP', '==', ip)
          .limit(1)
          .get();
        
        if (!ipQuery.empty) {
          return {
            exists: true,
            docId: ipQuery.docs[0].id,
            review: ipQuery.docs[0].data()
          };
        }
        
        return { exists: false };
      } catch (error) {
        console.error("Error checking existing review:", error);
        return { exists: false };
      }
    }

    /* Review Functions */
    async function saveReview(imdbID, rating, reviewerName, reviewText) {
      await initializeAuth();
      const ip = await getUserIP();
      const userId = firebase.auth().currentUser?.uid;
      
      try {
        // First delete existing review if updating
        if (existingReviewDocId) {
          await db.collection('reviews').doc(existingReviewDocId).delete();
        }
        
        // Get current review count
        const reviewsSnapshot = await db.collection('reviews').get();
        const count = reviewsSnapshot.size;
        
        // If we've reached the maximum, delete the oldest review
        if (count >= MAX_REVIEWS) {
          const oldestReview = await db.collection('reviews')
            .orderBy('date')
            .limit(1)
            .get();
            
          if (!oldestReview.empty) {
            await db.collection('reviews').doc(oldestReview.docs[0].id).delete();
          }
        }
        
        // Create new review
        await db.collection('reviews').add({
          imdbID,
          rating,
          reviewerName,
          text: reviewText,
          date: firebase.firestore.FieldValue.serverTimestamp(),
          userId: userId,
          userIP: ip
        });
        
        showSuccess(existingReviewDocId ? 'Review updated successfully!' : 'Review submitted successfully!');
        displayAllReviews();
      } catch (error) {
        console.error("Error saving review:", error);
        showError('Failed to submit review. Please try again.');
      } finally {
        existingReviewDocId = null;
      }
    }

    /* Delete Review Functions */
    function showDeleteConfirmModal(reviewId) {
      reviewToDeleteId = reviewId;
      deleteConfirmModal.style.display = 'flex';
    }

    function closeDeleteConfirmModal() {
      deleteConfirmModal.style.display = 'none';
      reviewToDeleteId = null;
    }

    async function confirmDeleteReview() {
      if (!reviewToDeleteId) return;
      
      try {
        await db.collection('reviews').doc(reviewToDeleteId).delete();
        showSuccess('Review deleted successfully!');
        displayAllReviews();
      } catch (error) {
        console.error("Error deleting review:", error);
        showError('Failed to delete review. Please try again.');
      } finally {
        closeDeleteConfirmModal();
      }
    }

    /* Delete Movie Functions */
    function showDeleteMovieConfirmModal(movieId) {
      movieToDeleteId = movieId;
      deleteMovieConfirmModal.style.display = 'flex';
    }

    function closeDeleteMovieConfirmModal() {
      deleteMovieConfirmModal.style.display = 'none';
      movieToDeleteId = null;
    }

    function confirmDeleteMovie() {
      if (!movieToDeleteId) return;
      
      try {
        let recent = JSON.parse(localStorage.getItem('recentMedia')) || [];
        recent = recent.filter(item => item.id !== movieToDeleteId);
        localStorage.setItem('recentMedia', JSON.stringify(recent));
        showSuccess('Movie removed from recent list!');
        renderRecentMedia();
      } catch (error) {
        console.error("Error deleting movie:", error);
        showError('Failed to delete movie. Please try again.');
      } finally {
        closeDeleteMovieConfirmModal();
      }
    }

    function showEditReviewModal() {
      editReviewModal.style.display = 'flex';
    }

    function closeEditReviewModal() {
      editReviewModal.style.display = 'none';
      pendingReviewData = null;
    }

    async function confirmEditReview() {
      if (!pendingReviewData || !currentImdbID) return;
      
      const { rating, reviewerName, text } = pendingReviewData;
      
      try {
        await saveReview(currentImdbID, rating, reviewerName, text);
        closeEditReviewModal();
        
        // Reset form
        reviewerName.value = '';
        reviewText.value = '';
        selectedRating = 0;
        updateStars(0);
      } catch (error) {
        console.error("Error updating review:", error);
        showError('Failed to update review. Please try again.');
      }
    }

    async function displayAllReviews() {
      reviewsGrid.innerHTML = '<div class="no-reviews">Loading reviews...</div>';
      
      const ip = await getUserIP();
      await initializeAuth();
      const userId = firebase.auth().currentUser?.uid;
      
      db.collection('reviews')
        .orderBy('date', 'desc')
        .limit(MAX_REVIEWS)
        .onSnapshot(async (snapshot) => {
          if (snapshot.empty) {
            reviewsGrid.innerHTML = '<div class="no-reviews">No reviews yet. Be the first to review!</div>';
            return;
          }
          
          // Process each review
          reviewsGrid.innerHTML = '';
          
          const reviews = [];
          snapshot.forEach(doc => reviews.push({ id: doc.id, ...doc.data() }));
          
          // Get all unique movie IDs from reviews
          const uniqueMovieIds = [...new Set(reviews.map(review => review.imdbID))];
          
          // Fetch all movie details in parallel
          const movieDetailsPromises = uniqueMovieIds.map(id => fetchMediaDetails(id));
          await Promise.all(movieDetailsPromises);
          
          // Create review items
          for (const review of reviews) {
            const movieDetails = allMovieDetailsCache[review.imdbID] || 
              { title: 'Unknown Movie', poster: null, year: '' };
            
            const reviewDate = review.date?.toDate() || new Date();
            const formattedDate = reviewDate.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            const reviewItem = document.createElement('div');
            reviewItem.className = 'review-item';
            
            // Check if this review belongs to the current user
            const isCurrentUserReview = (review.userId === userId) || (review.userIP === ip);
            
            reviewItem.innerHTML = `
              <div class="review-movie-info">
                ${movieDetails.poster ? `<img class="review-movie-poster" src="${movieDetails.poster}" alt="Poster">` : ''}
                <div class="review-movie-details">
                  <div class="review-movie-title">${movieDetails.title}${movieDetails.year ? ` (${movieDetails.year})` : ''}</div>
                  <div class="review-movie-id">${review.imdbID}</div>
                </div>
              </div>
              <div class="review-header">
                <div class="review-rating">${'★'.repeat(review.rating)}${'✰'.repeat(5 - review.rating)}</div>
                <div class="review-date">${formattedDate}</div>
              </div>
              <div class="review-content">${review.text}</div>
              <span class="review-author">-${review.reviewerName || 'Anonymous'}</span>
              ${isCurrentUserReview ? `
                <div class="review-item-actions">
                  <button class="delete-review-btn" onclick="event.stopPropagation(); showDeleteConfirmModal('${review.id}')">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              ` : ''}
            `;
            
            reviewItem.onclick = () => {
              imdbInput.value = review.imdbID;
              loadVideo(review.imdbID);
              // Smooth scroll to top
              window.scrollTo({
                top: 0,
                behavior: 'smooth'
              });
            };
            
            reviewsGrid.appendChild(reviewItem);
          }
        }, (error) => {
          console.error("Error loading reviews:", error);
          reviewsGrid.innerHTML = '<div class="no-reviews">Error loading reviews. Please refresh.</div>';
        });
    }

    /* Star Rating System */
    function initStarRating() {
      const stars = ratingStars.querySelectorAll('.star');
      
      stars.forEach(star => {
        star.addEventListener('click', () => {
          selectedRating = parseInt(star.getAttribute('data-value'));
          updateStars(selectedRating);
        });
        
        star.addEventListener('mouseover', () => {
          const hoverValue = parseInt(star.getAttribute('data-value'));
          updateStars(hoverValue);
        });
        
        star.addEventListener('mouseout', () => {
          updateStars(selectedRating);
        });
      });
    }
    
    function updateStars(rating) {
      const stars = ratingStars.querySelectorAll('.star');
      stars.forEach(star => {
        const value = parseInt(star.getAttribute('data-value'));
        star.classList.toggle('active', value <= rating);
      });
    }

    /* UI Functions */
    function showAdblockModal() {
      if (sessionStorage.getItem('adblockModalShown') !== 'true') {
        adblockModal.style.display = 'flex';
        sessionStorage.setItem('adblockModalShown', 'true');
      }
    }

    function closeAdblockModal() {
      adblockModal.style.display = 'none';
    }

    function showError(message) {
      const errorEl = document.createElement('div');
      errorEl.className = 'error-message';
      errorEl.textContent = message;
      document.body.appendChild(errorEl);
      
      setTimeout(() => {
        errorEl.classList.add('fade-out');
        setTimeout(() => errorEl.remove(), 500);
      }, 3000);
    }

    function showSuccess(message) {
      const successEl = document.createElement('div');
      successEl.className = 'success-message';
      successEl.textContent = message;
      document.body.appendChild(successEl);
      
      setTimeout(() => {
        successEl.classList.add('fade-out');
        setTimeout(() => successEl.remove(), 500);
      }, 3000);
    }

    function toggleHelpButton(show) {
      if (show && !helpButtonClicked) {
        helpButton.classList.add('visible');
      } else {
        helpButton.classList.remove('visible');
      }
    }

    function toggleGuidance(show) {
      if (show) {
        guidanceSection.classList.add('visible');
        helpButtonClicked = true;
        helpButton.classList.remove('visible');
      } else {
        guidanceSection.classList.remove('visible');
        helpButtonClicked = false;
        toggleHelpButton(true);
      }
    }

    function showGuide(show) {
      if (show) {
        guidanceSection.classList.add('visible');
        playerContainer.style.display = 'none';
        reviewSection.style.display = 'none';
      } else {
        guidanceSection.classList.remove('visible');
        playerContainer.style.display = 'flex';
        reviewSection.style.display = 'block';
      }
    }

    function showLoader(show) {
      loader.style.display = show ? 'block' : 'none';
    }

    /* Movie Data Functions */
    async function fetchMediaDetails(imdbID) {
      if (allMovieDetailsCache[imdbID]) {
        return allMovieDetailsCache[imdbID];
      }

      try {
        const response = await fetch(
          `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&i=${imdbID}`
        );
        const data = await response.json();
        if (data.Response === 'True') {
          const details = {
            title: data.Title,
            type: data.Type === 'movie' ? 'movie' : 'series',
            poster: data.Poster && data.Poster !== 'N/A' ? data.Poster : null,
            year: data.Year
          };
          allMovieDetailsCache[imdbID] = details;
          return details;
        } else {
          return { title: 'Unknown Title', type: 'unknown', poster: null, year: '' };
        }
      } catch {
        return { title: 'Error Fetching Title', type: 'unknown', poster: null, year: '' };
      }
    }

    // Fuzzy search function to handle typos and partial matches
    function fuzzyMatch(query, title) {
      if (!query || !title) return false;
      
      // Convert to lowercase for case-insensitive comparison
      query = query.toLowerCase().trim();
      title = title.toLowerCase().trim();
      
      // Exact match
      if (title.includes(query)) return true;
      
      // Remove common words and punctuation
      const commonWords = ['the', 'a', 'an', 'and', 'of', 'in', 'at', 'on', 'for'];
      const cleanQuery = query.split(' ').filter(word => !commonWords.includes(word)).join(' ');
      const cleanTitle = title.split(' ').filter(word => !commonWords.includes(word)).join(' ');
      
      if (cleanTitle.includes(cleanQuery)) return true;
      
      // Check for partial matches (at least 60% of words match)
      const queryWords = cleanQuery.split(' ').filter(Boolean);
      const titleWords = cleanTitle.split(' ').filter(Boolean);
      
      if (queryWords.length === 0 || titleWords.length === 0) return false;
      
      const matchingWords = queryWords.filter(qWord => 
        titleWords.some(tWord => tWord.includes(qWord))
      );
      
      return matchingWords.length / queryWords.length >= 0.6;
    }

    async function searchByTitle(query, isInitialSearch = false) {
      // Only trim whitespace from ends, preserve internal spaces
      query = query.trim();
      hasSearched = true;
      
      if (!query || query.length < 3) {
        if (isInitialSearch) {
          initialSearchResults.innerHTML = '<div class="initial-movie-item">Type at least 3 characters to search</div>';
          initialSearchResults.classList.add('visible');
        } else {
          searchResults.innerHTML = '<div class="no-results">Type at least 3 characters to search</div>';
          searchResults.classList.add('visible');
        }
        toggleHelpButton(false);
        return;
      }

      if (isInitialSearch) {
        initialSearchResults.innerHTML = '<div class="initial-movie-item">Searching...</div>';
        initialSearchResults.classList.add('visible');
      } else {
        searchResults.innerHTML = '<div class="search-loading">Searching...</div>';
        searchResults.classList.add('visible');
        // Hide initial search results when showing big results
        initialSearchResults.classList.remove('visible');
      }

      try {
        // First try searching with the exact query
        let response = await fetch(
          `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&s=${encodeURIComponent(query)}`
        );
        
        let data = await response.json();

        // Filter results to only include movies and series
        if (data.Response === 'True' && data.Search && data.Search.length > 0) {
          data.Search = data.Search.filter(item => item.Type === 'movie' || item.Type === 'series');
        }

        // If no results after filtering, try a more flexible search
        if (data.Response !== 'True' || !data.Search || data.Search.length === 0) {
          // Try with wildcard search
          response = await fetch(
            `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&s=${encodeURIComponent(query)}*`
          );
          data = await response.json();
          
          // Filter again
          if (data.Response === 'True' && data.Search && data.Search.length > 0) {
            data.Search = data.Search.filter(item => item.Type === 'movie' || item.Type === 'series');
          }
        }

        // If still no results, try with first word only
        if (data.Response !== 'True' || !data.Search || data.Search.length === 0) {
          const firstWord = query.split(' ')[0];
          if (firstWord.length >= 3) {
            response = await fetch(
              `https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&s=${encodeURIComponent(firstWord)}*`
            );
            data = await response.json();
            
            // Filter again
            if (data.Response === 'True' && data.Search && data.Search.length > 0) {
              data.Search = data.Search.filter(item => item.Type === 'movie' || item.Type === 'series');
            }
          }
        }

        if (data.Response === 'True' && data.Search && data.Search.length > 0) {
          // Sort results by relevance (using our fuzzy matching)
          data.Search.sort((a, b) => {
            const aMatch = fuzzyMatch(query, a.Title) ? 1 : 0;
            const bMatch = fuzzyMatch(query, b.Title) ? 1 : 0;
            
            // Also consider year (newer first)
            const yearDiff = parseInt(b.Year) - parseInt(a.Year);
            
            // Primary sort by match quality, secondary by year
            return (bMatch - aMatch) || yearDiff;
          });

          if (isInitialSearch) {
            initialSearchResults.innerHTML = '';
            
            // Show top 5 most relevant results in initial search
            const topResults = data.Search.slice(0, 5);
            
            topResults.forEach(item => {
              const movieItem = document.createElement('div');
              movieItem.className = 'initial-movie-item';
              movieItem.innerHTML = `
                <img src="${item.Poster !== 'N/A' ? item.Poster : 'https://via.placeholder.com/40x60?text=No+Poster'}" 
                     alt="${item.Title}" 
                     class="poster">
                <div class="info">
                  <div class="title">${item.Title}</div>
                  <div class="year">${item.Year}</div>
                </div>
                <div class="id">${item.imdbID}</div>
              `;
              movieItem.addEventListener('click', () => {
                imdbInput.value = item.imdbID;
                initialSearchResults.classList.remove('visible');
                loadVideo(item.imdbID);
              });
              initialSearchResults.appendChild(movieItem);
            });
          } else {
            searchResults.innerHTML = '';
            
            // Show all results in main search
            data.Search.forEach(item => {
              const movieCard = document.createElement('div');
              movieCard.className = 'movie-card';
              movieCard.innerHTML = `
                <img src="${item.Poster !== 'N/A' ? item.Poster : 'https://via.placeholder.com/300x450?text=No+Poster'}" 
                     alt="${item.Title}" 
                     class="movie-poster">
                <div class="movie-details">
                  <div class="movie-title">${item.Title}</div>
                  <div class="movie-year">${item.Year}</div>
                  <div class="movie-type">${item.Type === 'movie' ? 'Movie' : 'Series'}</div>
                  <div class="movie-id">${item.imdbID}</div>
                </div>
              `;
              movieCard.addEventListener('click', () => {
                imdbInput.value = item.imdbID;
                searchResults.classList.remove('visible');
                loadVideo(item.imdbID);
              });
              searchResults.appendChild(movieCard);
            });
            
            // Show help button at the bottom of search results
            toggleHelpButton(true);
          }
        } else {
          if (isInitialSearch) {
            initialSearchResults.innerHTML = '<div class="initial-movie-item">No movies or series found</div>';
          } else {
            searchResults.innerHTML = '<div class="no-results">No movies or series found</div>';
          }
          toggleHelpButton(true);
        }
      } catch (error) {
        console.error('Search error:', error);
        if (isInitialSearch) {
          initialSearchResults.innerHTML = '<div class="initial-movie-item">Error fetching results. Please try again.</div>';
        } else {
          searchResults.innerHTML = '<div class="no-results">Error fetching results. Please try again.</div>';
        }
        toggleHelpButton(true);
      }
    }

    async function renderRecentMedia() {
      let recent = JSON.parse(localStorage.getItem('recentMedia')) || [];
      if (recent.length === 0) {
        recentMoviesSection.style.display = 'none';
        return;
      }
      recentMoviesSection.style.display = 'block';
      recentMoviesList.innerHTML = '';

      recent = recent.slice(0, 21);
      const mediaItems = await Promise.all(recent.map(item => fetchMediaDetails(item.id)));

      recent.forEach((item, index) => {
        const { id } = item;
        const { title, type, poster } = mediaItems[index];
        const btn = document.createElement('button');
        const isUnknown = type === 'unknown';

        btn.title = `Load ${isUnknown ? 'media' : type} ${title} (${id})`;
        btn.addEventListener('click', (e) => {
          createRipple(e);
          imdbInput.value = id;
          updateURL(id);
          loadVideo(id);
        });

        btn.innerHTML = `
          ${poster ? `<img src="${poster}" alt="Poster of ${title}" />` : '<div class="poster-placeholder"></div>'}
          <div class="movie-info">
            <strong>${title}</strong>
            <small>${id}</small>
            <span class="media-type-badge ${type === 'movie' ? 'movie' : (type === 'series' ? 'series' : 'unknown')}">${isUnknown ? 'Unknown' : (type === 'movie' ? 'Movie' : 'Series')}</span>
          </div>
          <div class="movie-item-actions">
            <button class="delete-movie-btn" onclick="event.stopPropagation(); showDeleteMovieConfirmModal('${id}')">
              <i class="fas fa-trash" style="color: #ff4d4d; font-size: 0.9rem;"></i>
            </button>
          </div>
        `;

        recentMoviesList.appendChild(btn);
      });
    }

    function saveRecentMedia(imdbID, type) {
      let recent = JSON.parse(localStorage.getItem('recentMedia')) || [];
      recent = recent.filter(item => item.id !== imdbID);
      recent.unshift({ id: imdbID, type });
      if (recent.length > 21) {
        recent = recent.slice(0, 21);
      }
      localStorage.setItem('recentMedia', JSON.stringify(recent));
    }

    /* Player Functions */
    function updateURL(imdbID) {
      const url = new URL(window.location);
      url.searchParams.set('id', imdbID);
      window.history.replaceState(null, '', url.toString());
    }

    function removeMediaFromURL() {
      const url = new URL(window.location);
      url.searchParams.delete('id');
      window.history.replaceState(null, '', url.toString());
    }

    function toggleFullscreen() {
      if (!isMediaLoaded || isTypingReview) return;
      
      if (!document.fullscreenElement) {
        playerContainer.requestFullscreen().catch(err => {
          console.error(`Error attempting to enable fullscreen: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
    }

    function handleKeyDown(e) {
      // Allow spacebar in input fields
      if (e.target === imdbInput || e.target === reviewText || e.target === reviewerName) {
        return;
      }
      
      if (e.key === ' ') {
        e.preventDefault();
      }
      
      if (e.key.toLowerCase() === 'f' && isMediaLoaded && !isTypingReview) {
        toggleFullscreen();
      }
    }

    async function loadVideo(imdbID) {
      const validIDPattern = /^tt\d+$/;
      if (!validIDPattern.test(imdbID)) {
        showError('Please enter a valid IMDb ID (e.g., tt1234567)');
        return;
      }

      currentImdbID = imdbID;
      updateURL(imdbID);

      showLoader(true);
      playerContainer.style.display = 'flex';
      playerContainer.querySelectorAll('iframe').forEach((el) => el.remove());

      let mediaType = 'movie';
      let mediaDetails;
      try {
        mediaDetails = await fetchMediaDetails(imdbID);
        mediaType = mediaDetails.type === 'unknown' ? 'movie' : mediaDetails.type;
      } catch (e) {
        console.log("Couldn't determine media type, defaulting to movie");
      }

      const iframe = document.createElement('iframe');
      const baseUrl = mediaType === 'movie'
        ? `https://vidsrc.xyz/embed/movie/${imdbID}`
        : `https://vidsrc.xyz/embed/tv/${imdbID}`;
      
      iframe.src = `${baseUrl}?controls=0`;
      iframe.allowFullscreen = true;
      iframe.setAttribute('allow', 'autoplay; fullscreen');
      iframe.setAttribute('frameborder', '0');
      iframe.setAttribute('scrolling', 'no');

      iframe.onload = () => {
        showLoader(false);
        currentIframe = iframe;
        isMediaLoaded = true;
        saveRecentMedia(imdbID, mediaType);
        renderRecentMedia();
        
        // Check for existing review when video loads
        checkForExistingReview();
      };

      iframe.onerror = () => {
        showLoader(false);
        showError('Error loading video. Please try another ID or check if the content is available.');
        showGuide(true);
      };

      playerContainer.insertBefore(iframe, playerContainer.firstChild);
      showGuide(false);
    }

    async function checkForExistingReview() {
      if (!currentImdbID) return;
      
      const existingReview = await hasUserReviewed(currentImdbID);
      if (existingReview.exists) {
        existingReviewDocId = existingReview.docId;
        reviewerName.value = existingReview.review.reviewerName || '';
        reviewText.value = existingReview.review.text;
        selectedRating = existingReview.review.rating;
        updateStars(selectedRating);
      } else {
        existingReviewDocId = null;
        reviewerName.value = '';
        reviewText.value = '';
        selectedRating = 0;
        updateStars(0);
      }
    }

    /* Utility Functions */
    function createRipple(event) {
      const button = event.currentTarget;
      const circle = document.createElement('span');
      const diameter = Math.max(button.clientWidth, button.clientHeight);
      const radius = diameter / 2;
      
      circle.style.width = circle.style.height = `${diameter}px`;
      circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
      circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
      circle.classList.add('ripple');
      
      const ripple = button.getElementsByClassName('ripple')[0];
      if (ripple) {
        ripple.remove();
      }
      
      button.appendChild(circle);
      
      setTimeout(() => {
        circle.remove();
      }, 600);
    }

    function handleSearch(isInitialSearch = false) {
      const input = imdbInput.value.trim();
      hasSearched = true;
      
      if (!input) {
        if (isInitialSearch) {
          initialSearchResults.classList.remove('visible');
        } else {
          searchResults.classList.remove('visible');
        }
        toggleHelpButton(false);
        return;
      }

      // Check if input is an IMDb ID (starts with tt followed by numbers)
      if (/^tt\d+$/.test(input)) {
        // It's an ID, load directly
        loadVideo(input);
      } else {
        // It's a title search
        if (input.length < 3) {
          if (isInitialSearch) {
            initialSearchResults.innerHTML = '<div class="initial-movie-item">Type at least 3 characters to search</div>';
            initialSearchResults.classList.add('visible');
          } else {
            searchResults.innerHTML = '<div class="no-results">Type at least 3 characters to search</div>';
            searchResults.classList.add('visible');
          }
          toggleHelpButton(false);
          return;
        }

        if (isInitialSearch) {
          initialSearchResults.innerHTML = '<div class="initial-movie-item">Searching...</div>';
          initialSearchResults.classList.add('visible');
        } else {
          searchResults.innerHTML = '<div class="search-loading">Searching...</div>';
          searchResults.classList.add('visible');
          initialSearchResults.classList.remove('visible');
        }

        // Clear previous timeout if it exists
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }
        
        // Set new timeout with longer delay for better UX
        searchTimeout = setTimeout(() => {
          searchByTitle(input, isInitialSearch);
        }, 800);
      }
    }

    /* Event Listeners */
    searchBtn.addEventListener('click', (e) => {
      createRipple(e);
      handleSearch(false);
    });

    clearBtn.addEventListener('click', (e) => {
      createRipple(e);
      if (!isMediaLoaded && imdbInput.value === '') {
          showError('Nothing to clear - no media is currently playing');
          return;
      }
      
      imdbInput.value = '';
      playerContainer.style.display = 'none';
      reviewSection.style.display = 'none';
      searchResults.classList.remove('visible');
      initialSearchResults.classList.remove('visible');
      removeMediaFromURL();
      isMediaLoaded = false;
      currentImdbID = null;
      existingReviewDocId = null;
      
      // Restore guidance section if help button was clicked before
      if (helpButtonClicked) {
          guidanceSection.classList.add('visible');
          helpButton.classList.remove('visible');
      } else {
          guidanceSection.classList.remove('visible');
          toggleHelpButton(true);
      }
    });

    helpToggle.addEventListener('click', () => {
      toggleGuidance(!guidanceSection.classList.contains('visible'));
    });

    submitReviewBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      
      if (!currentImdbID) {
        showError('No movie selected to review');
        return;
      }
      
      if (selectedRating === 0) {
        showError('Please select a rating');
        return;
      }
      
      const name = reviewerName.value.trim();
      if (!name) {
        showError('Please enter your name');
        return;
      }
      
      const reviewContent = reviewText.value.trim();
      if (!reviewContent) {
        showError('Please write your review');
        return;
      }
      
      // Check for existing review (either by user ID or IP)
      const existingReview = await hasUserReviewed(currentImdbID);
      
      if (existingReview.exists) {
        // Show modal asking if they want to edit their existing review
        pendingReviewData = {
          rating: selectedRating,
          reviewerName: name,
          text: reviewContent
        };
        existingReviewDocId = existingReview.docId;
        showEditReviewModal();
        return;
      }
      
      // If no existing review, save as new review
      await saveReview(currentImdbID, selectedRating, name, reviewContent);
      
      // Reset form
      reviewerName.value = '';
      reviewText.value = '';
      selectedRating = 0;
      updateStars(0);
    });

    // Handle Enter key in review textarea and name field
    reviewText.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitReviewBtn.click();
      }
    });

    reviewerName.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitReviewBtn.click();
      }
    });

    // Track when user is typing in review
    reviewText.addEventListener('focus', () => {
      isTypingReview = true;
    });
    
    reviewText.addEventListener('blur', () => {
      isTypingReview = false;
    });

    fullscreenBtn.addEventListener('click', toggleFullscreen);
    fullscreenBtn.addEventListener('keydown', (e) => {
      if (e.key === ' ') {
        e.preventDefault();
      }
    });

    window.addEventListener('keydown', handleKeyDown);

    imdbInput.addEventListener('input', (e) => {
      // Only show search results if not typing an ID (starts with tt)
      if (!imdbInput.value.startsWith('tt')) {
        handleSearch(true);
      } else {
        initialSearchResults.classList.remove('visible');
      }
    });

    imdbInput.addEventListener('keydown', (e) => {
      // Allow spacebar in the input field
      if (e.key === ' ' && e.target === imdbInput) {
        return;
      }
      
      if (e.key === 'Enter') {
        handleSearch(false);
      }
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!searchResults.contains(e.target) && e.target !== imdbInput && !initialSearchResults.contains(e.target)) {
        searchResults.classList.remove('visible');
        initialSearchResults.classList.remove('visible');
      }
    });

    // Add ripple effect to all buttons
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
      button.addEventListener('click', createRipple);
    });

    /* Initialize App */
    window.addEventListener('load', () => {
      showAdblockModal();
      initStarRating();
      initializeAuth().then(() => {
        displayAllReviews();
      });
      
      const params = new URLSearchParams(window.location.search);
      const mediaID = params.get('id');
      
      if (mediaID) {
        imdbInput.value = mediaID;
        loadVideo(mediaID);
      }
      renderRecentMedia();
    });
  </script>
</body>
</html>
